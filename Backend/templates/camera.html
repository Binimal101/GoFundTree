<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoFundTree - Object Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

</head>
<body>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
    model-viewer {
      width: 100%;
      height: 100%;
    }
    </style>

    <!-- Top Row with Back Button -->
    <div class="container-fluid p-2 bg-light border-bottom">
        <div class="d-flex justify-content-start align-items-center">
            <!-- Back Button -->
            <button class="btn btn-outline-secondary" onclick="window.location.href='models.html'">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </div>
    </div>

    <!-- Camera/AR Area Placeholder -->
    <div class="container mt-3">
        <div class="mb-3" style="height: 400px; background-color: #e9ecef; border: 2px dashed #6c757d;">
            <!-- AR camera functionality placeholder -->
            <model-viewer id="modelViewer"
                ar 
                ar-modes="webxr scene-viewer quick-look"
                ar-scale="fixed"
                camera-controls 
                touch-action="pan-y"
                src=""
                ios-src=""
                alt="Environmental Object AR Model" 
                shadow-intensity="1" 
                max-camera-orbit="auto 90deg auto"
                xr-environment>
            </model-viewer>
        </div>
    </div>

    <!--Image preview--->
    <div class="container">
        <div class="mb-3">
            <center>
                <img id="preview" width="50%" height="50%"" alt="Photo Preview"/>
            </center>
        </div>
    </div>

    <!-- Upload File Button -->
    <div class="container">
        <div class="mb-3">
            <center>
                <input type="file" id="photoInput" accept="image/*"/>
            </center>
        </div>
    </div>


    <!-- Post Button -->
    <div class="container">
        <div class="d-grid gap-2">
            <button class="btn btn-success" id="postBtn">Post</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var pngDataURL = ""

        document.getElementById("postBtn").addEventListener('click', async (event) => {
    try {
        if(pngDataURL !== "") {

            try {
                const response = await fetch(`http://127.0.0.1:5000/api/uploadFile/{{PID}}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: pngDataURL })  // Send base64 image data
                });

                const result = await response.json();
                if (response.ok) {
                    console.log(result.message);
                } else {
                    console.log(`Error: ${result.message} ${response.json}`);
                }
            } catch (error) {
                alert(`Error: ${error} ${error.json}`);
            }
        } else {
            console.log("No image to upload.");
        }
    } catch (error) {
        alert(`Error: ${error}`);
    }
});


    document.getElementById("photoInput").addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (file) {
        try {
            const dataURL = await readImageAsDataUrl(file);
            pngDataURL = await convertToPng(dataURL);
            preview.src = pngDataURL;
            preview.style.display = 'block';
        } catch (error) {
            alert(`Error: ${error}`);
        }
        }
    });
    
    // Read an image file as a data URL
    function readImageAsDataUrl(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => reject('Failed to read the image file.');
            reader.readAsDataURL(file);
        });
    }

    // Convert the image to PNG using a canvas
    function convertToPng(dataUrl) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            canvas.getContext('2d').drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/png'));

            };
            img.onerror = () => reject('Failed to load the image.');
            img.src = dataUrl;
        });
    }

    </script>

    <script>
        // Ensure the DOM is fully loaded before accessing elements
        document.addEventListener('DOMContentLoaded', function () {
            const modelViewer = document.getElementById('modelViewer');

            // Fetch the PID from the backend and load the appropriate model
            async function fetchAndLoadModel() {
                try {
                    // Fetch the PID and model data from the backend
                    console.log("o3dOvcBn5QVkVylE6El9");
                    const response = await fetch('http://127.0.0.1:5000/api/get3D/o3dOvcBn5QVkVylE6El9');
                
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.statusText}`);
                    }

                    // Parse the response to get model data
                    const data = await response.json();
                    const modelUrl = data.url;  // Model URL 
                    const PID = data.PID;  // PID 
                    const platform = data.OS;

                    console.log(`Model URL: ${modelUrl}, PID: ${PID}`); // For debugging
                    console.log(platform);

                    // Detect the OS and use correct model
                    if (platform === 'ios') {
                        modelViewer.setAttribute('ios-src', modelUrl);  // iOS model (usdz)
                    } else {
                        modelViewer.setAttribute('src', modelUrl);  // Android/Web model (glb)
                    }
                } catch (error) {
                    console.error('Error fetching or loading the model:', error);
                }
            }
            
            // Call the function to fetch and load the model when the page loads
            fetchAndLoadModel();
        });
    </script>

</body>
</html>
